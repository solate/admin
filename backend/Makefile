.PHONY: help build run test clean migrate-up migrate-down migrate-create migrate-reset gen-db init dev lint fmt swagger

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# å˜é‡å®šä¹‰
APP_NAME := admin-backend
MAIN_PATH := ./cmd/server
BUILD_DIR := ./bin
MIGRATION_DIR := ./migrations

# æ•°æ®åº“é…ç½®ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼‰
DB_HOST ?= localhost
DB_PORT ?= 5432
DB_USER ?= postgres
DB_PASSWORD ?= postgres
DB_NAME ?= admin

# æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
DB_URL := postgres://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=disable

## help: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "==================================="
	@echo "Admin Backend - å¯ç”¨å‘½ä»¤"
	@echo "==================================="
	@echo ""
	@echo "ğŸš€ å¼€å‘å‘½ä»¤:"
	@echo "  make dev         - å¼€å‘æµç¨‹ï¼ˆmigrate + gen-db + runï¼‰"
	@echo "  make init        - é¦–æ¬¡åˆå§‹åŒ–é¡¹ç›®"
	@echo "  make run         - ä»…è¿è¡Œåº”ç”¨"
	@echo ""
	@echo "ğŸ“¦ æ„å»ºå‘½ä»¤:"
	@echo "  make build       - ç¼–è¯‘åº”ç”¨"
	@echo "  make clean       - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo ""
	@echo "ğŸ—„ï¸  æ•°æ®åº“è¿ç§»:"
	@echo "  make migrate-up       - æ‰§è¡Œæ•°æ®åº“è¿ç§»"
	@echo "  make migrate-down     - å›æ»šæ•°æ®åº“è¿ç§»ï¼ˆä¸€æ­¥ï¼‰"
	@echo "  make migrate-reset    - å®Œå…¨é‡ç½®æ•°æ®åº“ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰"
	@echo "  make migrate-create NAME=xxx - åˆ›å»ºæ–°è¿ç§»æ–‡ä»¶"
	@echo ""
	@echo "âš™ï¸  ä»£ç ç”Ÿæˆ:"
	@echo "  make gen-db         - ä»æ•°æ®åº“ç”Ÿæˆ Model + æŸ¥è¯¢ä»£ç "
	@echo ""
	@echo "ğŸ“š æ–‡æ¡£:"
	@echo "  make swagger        - ç”ŸæˆSwaggeræ–‡æ¡£"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•å’Œè´¨é‡:"
	@echo "  make test           - è¿è¡Œæµ‹è¯•"
	@echo "  make lint           - è¿è¡Œä»£ç æ£€æŸ¥"
	@echo "  make fmt            - æ ¼å¼åŒ–ä»£ç "
	@echo ""

## dev: å¼€å‘æµç¨‹ï¼ˆmigrate + gen-db + runï¼‰
dev: migrate-up gen-db
	@echo "ğŸš€ å¯åŠ¨åº”ç”¨..."
	@echo ""
	go run $(MAIN_PATH)/main.go

## init: é¦–æ¬¡åˆå§‹åŒ–é¡¹ç›®
init:
	@echo "======================================"
	@echo "ğŸ“¦ åˆå§‹åŒ– Admin Backend é¡¹ç›®"
	@echo "======================================"
	@echo ""
	@echo "1ï¸âƒ£  å®‰è£… Go ä¾èµ–..."
	go mod download
	@echo ""
	@echo "2ï¸âƒ£  æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
	@echo "   æ•°æ®åº“: $(DB_HOST):$(DB_PORT)/$(DB_NAME)"
	@echo "   ç”¨æˆ·: $(DB_USER)"
	@echo ""
	@echo "ğŸ’¡ æç¤º: ç¡®ä¿ PostgreSQL æ­£åœ¨è¿è¡Œï¼ˆDocker æˆ–æœ¬åœ°ï¼‰"
	@echo ""
	@echo "3ï¸âƒ£  æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	@$(MAKE) migrate-up
	@echo ""
	@echo "4ï¸âƒ£  ç”Ÿæˆ gorm/gen ä»£ç ..."
	@$(MAKE) gen-db
	@echo ""
	@echo "======================================"
	@echo "âœ… åˆå§‹åŒ–å®Œæˆï¼"
	@echo "======================================"
	@echo ""
	@echo "ğŸš€ è¿è¡Œ 'make dev' å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo ""

## build: ç¼–è¯‘åº”ç”¨
build:
	@echo "ğŸ”¨ ç¼–è¯‘åº”ç”¨..."
	@mkdir -p $(BUILD_DIR)
	go build -o $(BUILD_DIR)/$(APP_NAME) $(MAIN_PATH)
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(BUILD_DIR)/$(APP_NAME)"

## run: è¿è¡Œåº”ç”¨
run:
	@echo "ğŸš€ è¿è¡Œåº”ç”¨..."
	go run $(MAIN_PATH)/main.go

## test: è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	go test -v -cover ./...

## clean: æ¸…ç†ç¼–è¯‘æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -rf $(BUILD_DIR)
	rm -rf tmp/
	@echo "âœ… æ¸…ç†å®Œæˆ"

## gen-db: ä»æ•°æ®åº“ç”Ÿæˆ Model å’ŒæŸ¥è¯¢ä»£ç 
gen-db:
	@echo "======================================"
	@echo "âš™ï¸  ä»æ•°æ®åº“ç”Ÿæˆä»£ç ï¼ˆè´«è¡€æ¨¡å‹ï¼‰"
	@echo "======================================"
	@echo ""
	@echo "ğŸ“ æ•°æ®æº: PostgreSQL æ•°æ®åº“è¡¨"
	@echo "ğŸ“ ç”Ÿæˆç›®å½•: internal/dal/model/ + internal/dal/query/"
	@echo ""
	@go run scripts/gen_from_db.go
	@echo ""

## migrate-up: æ‰§è¡Œæ•°æ®åº“è¿ç§»
migrate-up:
	@echo "â¬†ï¸  æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	@if command -v migrate > /dev/null; then \
		migrate -path $(MIGRATION_DIR) -database "$(DB_URL)" up; \
		echo "âœ… è¿ç§»å®Œæˆ"; \
	else \
		echo ""; \
		echo "âŒ golang-migrate æœªå®‰è£…"; \
		echo ""; \
		echo "å®‰è£…æ–¹æ³•:"; \
		echo "  macOS:   brew install golang-migrate"; \
		echo "  Linux:   wget https://github.com/golang-migrate/migrate/releases/latest/download/migrate.linux-amd64.tar.gz"; \
		echo "  Windows: scoop install migrate"; \
		echo ""; \
		echo "æˆ–è®¿é—®: https://github.com/golang-migrate/migrate"; \
		echo ""; \
		exit 1; \
	fi

## migrate-down: å›æ»šæ•°æ®åº“è¿ç§»ï¼ˆä¸€æ­¥ï¼‰
migrate-down:
	@echo "â¬‡ï¸  å›æ»šæ•°æ®åº“è¿ç§»ï¼ˆä¸€æ­¥ï¼‰..."
	@if command -v migrate > /dev/null; then \
		migrate -path $(MIGRATION_DIR) -database "$(DB_URL)" down 1; \
		echo "âœ… å›æ»šå®Œæˆ"; \
	else \
		echo "âŒ golang-migrateæœªå®‰è£…"; \
		exit 1; \
	fi

## migrate-reset: å®Œå…¨é‡ç½®æ•°æ®åº“ï¼ˆå±é™©æ“ä½œï¼‰
migrate-reset:
	@echo "âš ï¸  è­¦å‘Šï¼šå³å°†å®Œå…¨é‡ç½®æ•°æ®åº“ï¼"
	@echo "æŒ‰ Ctrl+C å–æ¶ˆï¼Œæˆ–æŒ‰å›è½¦ç»§ç»­..."
	@read confirm
	@echo "â¬‡ï¸  å›æ»šæ‰€æœ‰è¿ç§»..."
	@migrate -path $(MIGRATION_DIR) -database "$(DB_URL)" down -all || true
	@echo "â¬†ï¸  é‡æ–°æ‰§è¡Œè¿ç§»..."
	@migrate -path $(MIGRATION_DIR) -database "$(DB_URL)" up
	@echo "âœ… æ•°æ®åº“é‡ç½®å®Œæˆ"

## migrate-create: åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶ (ä½¿ç”¨æ–¹æ³•: make migrate-create NAME=add_user_table)
migrate-create:
	@if [ -z "$(NAME)" ]; then \
		echo "âŒ è¯·æŒ‡å®šè¿ç§»åç§°: make migrate-create NAME=your_migration_name"; \
		exit 1; \
	fi
	@if command -v migrate > /dev/null; then \
		migrate create -ext sql -dir $(MIGRATION_DIR) -seq $(NAME); \
	else \
		echo "âŒ golang-migrateæœªå®‰è£…"; \
		exit 1; \
	fi
## lint: è¿è¡Œä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run; \
	else \
		echo "âŒ golangci-lintæœªå®‰è£…"; \
		echo "å®‰è£…: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"; \
		exit 1; \
	fi

## fmt: æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ“ æ ¼å¼åŒ–ä»£ç ..."
	gofmt -s -w .
	go mod tidy
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

## swagger: ç”ŸæˆSwaggeræ–‡æ¡£
swagger:
	@echo "ğŸ“š ç”ŸæˆSwaggeræ–‡æ¡£..."
	@if command -v swag > /dev/null; then \
		swag init -g cmd/server/main.go -o docs; \
	else \
		echo "âŒ swagæœªå®‰è£…"; \
		echo "å®‰è£…: go install github.com/swaggo/swag/cmd/swag@latest"; \
		exit 1; \
	fi

## install-tools: å®‰è£…å¼€å‘å·¥å…·
install-tools:
	@echo "ğŸ”§ å®‰è£…å¼€å‘å·¥å…·..."
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install github.com/swaggo/swag/cmd/swag@latest
	@echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
