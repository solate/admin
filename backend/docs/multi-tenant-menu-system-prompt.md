# 多租户 SaaS 菜单系统设计 - 完整需求提示词

## 背景信息

我正在开发一个**多租户 SaaS 后台管理系统**，需要设计菜单和权限系统。现有技术栈：
- 后端：Go + GORM + Casbin（RBAC with Domains）
- 数据库：已存在 `permissions` 表，支持 MENU/BUTTON/API 三种类型
- 前端：Vue 3
- 权限模型：RBAC with Domains（支持租户隔离）

现有 `permissions` 表结构：
```sql
CREATE TABLE permissions (
    permission_id VARCHAR(255) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL,  -- MENU, BUTTON, API
    parent_id VARCHAR(255),
    resource VARCHAR(255),
    action VARCHAR(20),
    path VARCHAR(255),
    component VARCHAR(255),
    icon VARCHAR(100),
    sort SMALLINT,
    status SMALLINT DEFAULT 1,
    created_at BIGINT,
    updated_at BIGINT,
    deleted_at BIGINT DEFAULT 0
);
```

---

## 核心需求

### 1. 三层权限控制
- **菜单级**：用户能看到哪些菜单
- **按钮级**：用户能在页面上看到哪些按钮（新增、删除、编辑、导出等）
- **API级**：用户能调用哪些后端接口

### 2. 多租户场景
- **超级管理员**（租户ID=0）：
  - 定义完整的"权限资源池"（所有菜单和按钮）
  - 新增租户时，给租户勾选可用的菜单 (主要是租户管理不能给租户看到)
- **租户管理员**：
  - 在超管给定的菜单范围内
  - 给不同角色分配不同的菜单和按钮权限
  - 极个别情况可以添加自定义菜单（不影响其他租户）

### 3. 前端操作流程
```
超管操作：
1. 超管定义权限资源树（菜单 + 按钮）
2. 新增租户时，超管为该租户勾选可用菜单

租户管理员操作：
3. 创建角色时，勾选该角色能访问的菜单和按钮权限
   - 例如：销售角色 -> 订单菜单(查看+新增)、商品菜单(仅查看)
   - 例如：财务角色 -> 订单菜单(查看+导出)

用户登录后：
4. 根据用户角色，动态加载可见菜单和按钮
```

### 4. 示例场景

```
超管定义的权限资源：
├─ 系统管理 [MENU]
│  ├─ 用户管理 [MENU]
│  │  ├─ 查看 [BUTTON] - GET /system/users
│  │  ├─ 新增 [BUTTON] - POST /system/users
│  │  ├─ 编辑 [BUTTON] - PUT /system/users
│  │  └─ 删除 [BUTTON] - DELETE /system/users
│  └─ 角色管理 [MENU]
│     ├─ 查看 [BUTTON]
│     └─ 新增 [BUTTON]
├─ 业务管理 [MENU]
│  ├─ 订单管理 [MENU]
│  │  ├─ 查看 [BUTTON]
│  │  ├─ 新增 [BUTTON]
│  │  └─ 导出 [BUTTON]
│  └─ 商品管理 [MENU]
│     └─ 查看 [BUTTON]

租户A（超管给租户A勾选了：用户管理、订单管理）

租户A创建两个角色：
- 销售角色：订单管理(查看+新增)、用户管理(仅查看)
- 财务角色：订单管理(查看+导出)、用户管理(仅查看)

租户A的自定义需求：
- 添加了一个"内部公告"自定义菜单（不影响其他租户）
```

---

## 请对比以下方案，并给出推荐

### 方案A：基于现有 permissions 表的扩展方案

**核心思路**：
- 超管在 `permissions` 表（tenant_id=0）定义完整的权限资源树
- 新增 `tenant_enabled_menus` 表：超管给租户勾选菜单
- 租户管理员直接使用 Casbin 策略给角色分配权限
- 租户自定义菜单：在 `permissions` 表插入租户自己的菜单

**优点**：
- 复用现有表结构，改动最小
- 菜单和按钮统一在 permissions 表管理
- 权限控制完全由 Casbin 处理

**缺点**：
- 超管给租户勾选菜单，租户管理员又给角色分配权限，两层管理可能混乱
- 租户自定义菜单和系统菜单如何区分？

---

### 方案B：模块化组合方案

**核心思路**：
- 超管定义功能模块（用户模块、订单模块等）
- 每个模块包含完整的菜单+按钮树
- `tenant_modules` 表：租户订阅模块
- Casbin 控制角色在模块内的具体权限

**优点**：
- 模块化清晰，适合套餐管理（基础版/专业版）
- 租户启用/禁用功能模块很简单

**缺点**：
- 粒度太粗：要么给整个模块，要么不给
- 租户管理员想要"订单查看+新增，但不要导出"，这种细粒度控制不灵活

---

### 方案C：三层隔离方案

**核心思路**：
- `system_permissions`：超管定义的权限池
- `tenant_permissions`：租户启用的权限（从系统复制+自定义）
- Casbin：控制角色与权限的映射

**优点**：
- 每层职责清晰
- 租户完全隔离

**缺点**：
- 数据冗余（权限从系统复制到租户）
- 超管修改权限后，需要同步到所有租户

---

### 方案D：其他你认为更合适的方案

---

## 我需要你回答的问题

1. **方案对比**：详细对比上述方案的优缺点，特别是针对我的需求场景
2. **推荐方案**：结合我的需求，推荐最合适的方案
3. **数据库设计**：给出推荐的完整数据库表结构（含索引）
4. **Casbin 集成**：给出 Casbin 策略模型和具体策略示例
5. **权限检查流程**：
   - 前端如何获取用户的菜单和按钮权限？
   - 后端如何检查 API 调用权限？
   - 超管给租户勾选菜单后，租户管理员如何给角色分配权限？
6. **代码实现**：给出关键代码示例（Go 语言）
7. **租户自定义菜单**：如何实现租户添加自定义菜单，且不影响其他租户？
8. **常见场景**：
   - 新增租户的默认权限如何处理？
   - 租户升级套餐（增加菜单）如何处理？
   - 超管修改了权限池，如何影响已有租户？

---

## 技术约束

- 必须使用 Casbin（RBAC with Domains）
- 必须支持菜单级、按钮级、API级三层权限
- 必须支持多租户隔离
- 租户大部分场景使用相同菜单（90%），极少数需要自定义（10%）
- 前端需要根据权限动态渲染菜单和按钮

---

## 期望输出

请按以下结构输出你的回答：

1. **方案推荐**：推荐方案及理由
2. **方案对比表**：各方案优缺点对比
3. **数据库设计**：完整表结构
4. **Casbin 策略设计**：模型文件和策略示例
5. **权限检查流程**：前后端完整流程图
6. **代码实现**：关键代码示例
7. **常见场景处理**：新增租户、套餐升级、权限池变更等
8. **注意事项**：可能遇到的问题和解决方案

---

## 附加说明

- 我现有的系统已经有用户管理、角色管理功能
- 使用 GORM 作为 ORM
- 前端使用 Vue 3，需要 API 接口返回用户的菜单树和按钮权限
- 考虑性能问题，可能需要加缓存

请给出详细、可落地的方案。
