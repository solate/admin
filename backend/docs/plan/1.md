# å¤šç§Ÿæˆ·SaaSåç«¯ç®¡ç†ç³»ç»Ÿè®¾è®¡

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

**åˆ†é…æœºåˆ¶**ï¼šè¶…ç®¡åˆ›å»ºç³»ç»Ÿæ¨¡æ¿ â†’ å‹¾é€‰åˆ†é…ç»™ç§Ÿæˆ· â†’ ç§Ÿæˆ·çœ‹åˆ°è¢«åˆ†é…çš„æ•°æ®

**è§’è‰²å±‚çº§**ï¼š
- è¶…çº§ç®¡ç†å‘˜ (SuperAdmin)ï¼šç®¡ç†å¹³å°æ¨¡æ¿ï¼Œåˆ†é…ç»™ç§Ÿæˆ·
- ç§Ÿæˆ·ç®¡ç†å‘˜ (TenantAdmin)ï¼šç»§æ‰¿ç³»ç»Ÿæ¨¡æ¿ï¼Œæ·»åŠ è‡ªå®šä¹‰æ•°æ®
- æ™®é€šç”¨æˆ· (User)ï¼šä½¿ç”¨è¢«æˆæƒçš„åŠŸèƒ½

---

## 1. æ•°æ®åº“è®¾è®¡

### 1.1 èœå•ç³»ç»Ÿ

> è¯¦ç»†è®¾è®¡è§ [menu-system-design.md](./menu-system-design.md)

**è¡¨ç»“æ„**ï¼š
- `menus` - èœå•å…ƒæ•°æ®ï¼ˆåç§°ã€è·¯å¾„ã€ç»„ä»¶ç­‰ï¼‰
- `tenant_menus` - ç§Ÿæˆ·èœå•è¾¹ç•Œ
- `roles` - è§’è‰²å®šä¹‰
- `permissions` - æƒé™ç‚¹å®šä¹‰ï¼ˆMENU/BUTTON/APIï¼‰

### 1.2 å­—å…¸è¡¨

> è¯¦ç»†è®¾è®¡è§ [dict-system-design.md](./dict-system-design.md)

**è¡¨ç»“æ„**ï¼š
- `dict_types` - å­—å…¸ç±»å‹ï¼ˆç³»ç»Ÿå­—å…¸æ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼‰
- `dict_items` - å­—å…¸é¡¹

### 1.3 ç»„ç»‡è¡¨ (organizations)

```sql
CREATE TABLE organizations (
    org_id VARCHAR(20) PRIMARY KEY,
    tenant_id VARCHAR(20) NOT NULL,
    parent_id VARCHAR(20),
    org_name VARCHAR(100) NOT NULL,
    org_code VARCHAR(50),
    leader_id VARCHAR(20),
    phone VARCHAR(20),
    description TEXT,
    sort INT DEFAULT 0,
    status SMALLINT DEFAULT 1,
    created_at BIGINT NOT NULL DEFAULT 0,
    updated_at BIGINT NOT NULL DEFAULT 0,
    deleted_at BIGINT DEFAULT 0,
    INDEX idx_tenant (tenant_id),
    INDEX idx_parent (parent_id)
);
```

---

## 2. scopes.go æ”¹é€ 

### 2.1 æ–°å¢å¸¸é‡å’Œå‡½æ•°

```go
const (
    TenantModeAuto   = "auto"   // è‡ªåŠ¨æ·»åŠ  tenant_id è¿‡æ»¤ï¼ˆé»˜è®¤ï¼‰
    TenantModeManual = "manual" // æ‰‹åŠ¨æ§åˆ¶ WHERE æ¡ä»¶
)

// ManualTenantMode è®¾ç½®æ‰‹åŠ¨æ¨¡å¼ï¼ŒRepository å®Œå…¨æ§åˆ¶ WHERE
func ManualTenantMode(ctx context.Context) context.Context {
    return context.WithValue(ctx, tenantModeKey, TenantModeManual)
}
```

### 2.2 æŸ¥è¯¢å›è°ƒé€»è¾‘

```
ä¼˜å…ˆçº§ï¼š
1. SkipTenantCheck      â†’ ä¸æ·»åŠ ä»»ä½•è¿‡æ»¤
2. TenantModeManual     â†’ ä¸è‡ªåŠ¨æ·»åŠ ï¼ŒRepository æ‰‹åŠ¨æ§åˆ¶ WHERE
3. é»˜è®¤ (TenantModeAuto) â†’ è‡ªåŠ¨æ·»åŠ  WHERE tenant_id = ?
```

---

## 3. Repository å±‚å°è£…ç¤ºä¾‹

### 3.1 ç»„ç»‡æŸ¥è¯¢

```go
// ç§Ÿæˆ·æŸ¥è¯¢ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
func (r *OrgRepo) ListByTenant(ctx context.Context, tenantID string) ([]*model.Organization, error) {
    ctx = database.WithTenantID(ctx, tenantID)
    return r.q.Organization.WithContext(ctx).Find()
}

// è¶…ç®¡æŸ¥è¯¢æ‰€æœ‰ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
func (r *OrgRepo) ListAll(ctx context.Context) ([]*model.Organization, error) {
    ctx = database.ManualTenantMode(ctx)
    return r.q.Organization.WithContext(ctx).Find()
}
```

---

## 4. API è®¾è®¡

### è¶…ç®¡æ“ä½œ

```
POST   /api/v1/system/menus                    åˆ›å»ºç³»ç»Ÿèœå•
PUT    /api/v1/system/menus/:id                æ›´æ–°ç³»ç»Ÿèœå•
POST   /api/v1/system/menus/assign             åˆ†é…èœå•ç»™ç§Ÿæˆ·
DELETE /api/v1/system/menus/unassign           æ’¤é”€åˆ†é…

POST   /api/v1/system/dict-types               åˆ›å»ºç³»ç»Ÿå­—å…¸
POST   /api/v1/system/dict-types/assign        åˆ†é…å­—å…¸ç»™ç§Ÿæˆ·
```

### ç§Ÿæˆ·æ“ä½œ

```
GET    /api/v1/menus                           è·å–èœå•ï¼ˆç³»ç»Ÿ+è‡ªå®šä¹‰ï¼‰
POST   /api/v1/menus                           åˆ›å»ºè‡ªå®šä¹‰èœå•
PUT    /api/v1/menus/:id/override              è¦†ç›–ç³»ç»Ÿèœå•å±æ€§

GET    /api/v1/dict-types                      è·å–å­—å…¸ç±»å‹
POST   /api/v1/dict-types                      åˆ›å»ºè‡ªå®šä¹‰å­—å…¸

GET    /api/v1/orgs                            è·å–ç»„ç»‡ç»“æ„
POST   /api/v1/orgs                            åˆ›å»ºç»„ç»‡
```

---

## 5. å¸¸é‡å®šä¹‰

```go
package constants

const (
    // ç§Ÿæˆ·
    DefaultTenantID   = "000000000000000000" // é»˜è®¤ç§Ÿæˆ·IDï¼ˆ18ä¸ªé›¶ï¼‰
    DefaultTenantCode = "default" // é»˜è®¤ç§Ÿæˆ·code

    // ç”¨æˆ·ç±»å‹
    UserTypeUser        = 1 // æ™®é€šç”¨æˆ·
    UserTypeTenantAdmin = 2 // ç§Ÿæˆ·ç®¡ç†å‘˜
    UserTypeSuperAdmin  = 3 // è¶…çº§ç®¡ç†å‘˜

    // æ¥æºç±»å‹
    SourceTypeSystem = "SYSTEM"
    SourceTypeCustom = "CUSTOM"

    // èœå•ç±»å‹
    TypeMenu   = "MENU"
    TypeButton = "BUTTON"
)
```

---

## 6. å®ç°æ¸…å•

### æ•°æ®åº“

- [x] `pkg/database/scopes.go` æ·»åŠ  `ManualTenantMode`
- [x] `pkg/constants/system.go` æ·»åŠ  `DefaultTenantID = "000000000000000000"`
- [ ] èœå•è¡¨ï¼š`parent_id`, `name`, `path`, `sort`
- [ ] æ–°å»º `tenant_menus` è¡¨ï¼ˆç§Ÿæˆ·èœå•è¾¹ç•Œï¼Œä¸ SQL ä¸€è‡´ï¼‰
- [ ] è§’è‰²è¡¨ï¼š`tenant_id`, `name`, `code`, `type`
- [ ] æƒé™è¡¨ï¼š`name`, `type`, `resource`, `action`
- [ ] å­—å…¸ç±»å‹è¡¨ï¼š`tenant_id`, `type_code`, `type_name`
- [ ] å­—å…¸é¡¹è¡¨ï¼š`type_id`, `tenant_id`, `label`, `value`, `sort`
- [ ] ç»„ç»‡è¡¨ï¼š`tenant_id`, `parent_id`, `org_name`, `org_code`

### åç«¯ä»£ç 

#### èœå•ç³»ç»Ÿï¼ˆè§ [menu-system-design.md](./menu-system-design.md)ï¼‰
- [ ] `internal/repository/menu_repo.go` èœå•æŸ¥è¯¢
- [ ] `internal/repository/tenant_menu_repo.go` ç§Ÿæˆ·èœå•è¾¹ç•Œ
- [ ] `internal/service/menu_service.go` åˆ›å»ºã€åˆ†é…ã€è¦†ç›–é€»è¾‘
- [ ] `internal/router/` æ·»åŠ è¶…ç®¡åˆ†é…æ¥å£

#### å­—å…¸ç³»ç»Ÿï¼ˆè§ [dict-system-design.md](./dict-system-design.md)ï¼‰
- [ ] `internal/repository/dict_type_repo.go` å­—å…¸ç±»å‹
- [ ] `internal/repository/dict_item_repo.go` å­—å…¸é¡¹
- [ ] `internal/service/dict_service.go` åˆ›å»ºã€è¦†ç›–ã€æ¢å¤é€»è¾‘
- [ ] `internal/router/` æ·»åŠ è¶…ç®¡å­—å…¸æ¥å£

#### è§’è‰²æƒé™ç³»ç»Ÿï¼ˆè§ [menu-system-design.md](./menu-system-design.md)ï¼‰
- [ ] `internal/repository/role_repo.go` è§’è‰²ç®¡ç†
- [ ] `internal/repository/permission_repo.go` æƒé™ç‚¹ç®¡ç†
- [ ] `internal/service/role_service.go` ç»§æ‰¿ã€è‡ªå®šä¹‰è§’è‰²
- [ ] `internal/service/auth_service.go` æƒé™æ£€æŸ¥

---

## 7. å¾…è¡¥å……åŠŸèƒ½

ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå¸¸ç”¨åŠŸèƒ½ï¼‰
| æ¨¡å— | ç¼ºå°‘çš„è®¾è®¡å†…å®¹ | å¤æ‚åº¦ |
|------|---------------|--------|
| é€šçŸ¥ä¸­å¿ƒ | ç«™å†…æ¶ˆæ¯ã€é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥ã€é€šçŸ¥æ¨¡æ¿ç®¡ç† | ä¸­ |
| æ–‡ä»¶ç®¡ç† | æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ç§Ÿæˆ·éš”ç¦»å­˜å‚¨ã€æ–‡ä»¶åˆ†äº« | ä½ |
| APIç®¡ç† | APIå¯†é’¥ç®¡ç†ã€APIé™æµ/é‰´æƒã€APIæ–‡æ¡£ï¼ˆSwaggerï¼‰ | ä¸­ |

ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯æ ¹æ®éœ€è¦è¡¥å……ï¼‰
| æ¨¡å— | ç¼ºå°‘çš„è®¾è®¡å†…å®¹ | å¤æ‚åº¦ |
|------|---------------|--------|
| å®šæ—¶ä»»åŠ¡ | ä»»åŠ¡è°ƒåº¦ç®¡ç†ã€æ‰§è¡Œç›‘æ§ã€ä»»åŠ¡æ—¥å¿— | ä½ |
| ç›‘æ§å‘Šè­¦ | ç³»ç»Ÿæ€§èƒ½ç›‘æ§ã€å¼‚å¸¸å‘Šè­¦ã€èµ„æºä½¿ç”¨ç›‘æ§ã€ç§Ÿæˆ·ç”¨é‡ç»Ÿè®¡ | é«˜ |
| å¤‡ä»½æ¢å¤ | æ•°æ®å¤‡ä»½ã€æ•°æ®æ¢å¤ã€ç§Ÿæˆ·æ•°æ®è¿ç§» | é«˜ |
| ç§Ÿæˆ·ç®¡ç† | ç§Ÿæˆ·æ³¨å†Œ/å¼€é€šã€å¥—é¤/ç‰ˆæœ¬ç®¡ç† | ä½ |
| ç³»ç»Ÿé…ç½® | ç³»ç»Ÿå‚æ•°é…ç½®ã€ç§Ÿæˆ·çº§é…ç½®ã€é…ç½®ç‰ˆæœ¬ç®¡ç† | ä½ |
| å‰ç«¯ä¸ªæ€§åŒ– | ä¸»é¢˜é…ç½®ã€å¸ƒå±€é…ç½®ã€é¦–é¡µé…ç½® | ä½ |
