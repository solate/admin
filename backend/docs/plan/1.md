# å¤šç§Ÿæˆ·SaaSåç«¯ç®¡ç†ç³»ç»Ÿè®¾è®¡

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

**åˆ†é…æœºåˆ¶**ï¼šè¶…ç®¡åˆ›å»ºç³»ç»Ÿæ¨¡æ¿ â†’ å‹¾é€‰åˆ†é…ç»™ç§Ÿæˆ· â†’ ç§Ÿæˆ·çœ‹åˆ°è¢«åˆ†é…çš„æ•°æ®

**è§’è‰²å±‚çº§**ï¼š
- è¶…çº§ç®¡ç†å‘˜ (SuperAdmin)ï¼šç®¡ç†å¹³å°æ¨¡æ¿ï¼Œåˆ†é…ç»™ç§Ÿæˆ·
- ç§Ÿæˆ·ç®¡ç†å‘˜ (TenantAdmin)ï¼šç»§æ‰¿ç³»ç»Ÿæ¨¡æ¿ï¼Œæ·»åŠ è‡ªå®šä¹‰æ•°æ®
- æ™®é€šç”¨æˆ· (User)ï¼šä½¿ç”¨è¢«æˆæƒçš„åŠŸèƒ½

---

## 1. æ•°æ®åº“è®¾è®¡

### 1.1 ç”¨æˆ·è§’è‰²ç³»ç»Ÿ

> è¯¦ç»†è®¾è®¡è§ [multi-tenant-login-design.md](./multi-tenant-login-design.md)

**è¡¨ç»“æ„**ï¼š
- `tenants` - ç§Ÿæˆ·è¡¨
- `users` - ç”¨æˆ·è¡¨
- `roles` - è§’è‰²è¡¨
- `user_roles` - ç”¨æˆ·è§’è‰²å…³è”è¡¨

**æ ¸å¿ƒè®¾è®¡**ï¼š
- ç”¨æˆ·å±äºå•ä¸ªç§Ÿæˆ·ï¼Œé€šè¿‡ `tenant_id` ç»‘å®š
- Casbin `(username, tenantCode, roleCode)` ä¸‰å…ƒç»„æƒé™æ§åˆ¶
- Token æºå¸¦ `roles` æ•°ç»„ï¼ŒåŒ…å« `super_admin` å³ä¸ºè¶…ç®¡

### 1.2 èœå•ç³»ç»Ÿ

> è¯¦ç»†è®¾è®¡è§ [menu-system-design.md](./menu-system-design.md)

**è¡¨ç»“æ„**ï¼š
- `menus` - èœå•å…ƒæ•°æ®ï¼ˆåç§°ã€è·¯å¾„ã€ç»„ä»¶ç­‰ï¼‰
- `tenant_menus` - ç§Ÿæˆ·èœå•è¾¹ç•Œ
- `roles` - è§’è‰²å®šä¹‰
- `permissions` - æƒé™ç‚¹å®šä¹‰ï¼ˆMENU/BUTTON/APIï¼‰

### 1.3 å­—å…¸è¡¨

> è¯¦ç»†è®¾è®¡è§ [dict-system-design.md](./dict-system-design.md)

**è¡¨ç»“æ„**ï¼š
- `dict_types` - å­—å…¸ç±»å‹ï¼ˆç³»ç»Ÿå­—å…¸æ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼‰
- `dict_items` - å­—å…¸é¡¹

### 1.4 ç»„ç»‡ç»“æ„ç³»ç»Ÿ

> è¯¦ç»†è®¾è®¡è§ [org-system-design.md](./org-system-design.md)

**è¡¨ç»“æ„**ï¼š
- `departments` - éƒ¨é—¨è¡¨ï¼ˆæŒ‰èŒèƒ½åˆ’åˆ†ï¼‰
- `positions` - å²—ä½è¡¨ï¼ˆæŒ‰èŒè´£å®šä¹‰ï¼‰
- `user_positions` - ç”¨æˆ·å¤šå²—å…³è”è¡¨ï¼ˆå¯é€‰ï¼‰

**æ ¸å¿ƒè®¾è®¡**ï¼š
- éƒ¨é—¨ä¸å²—ä½åˆ†ç¦»ï¼ŒèŒè´£æ¸…æ™°
- æ ‡å‡†åŒ–å²—ä½ç¼–ç ï¼ˆå¦‚ `DEPT_LEADER`ï¼‰ä¸ Casbin è§’è‰²å¯¹åº”
- æ”¯æŒä¸€äººå¤šå²—ï¼Œé€šè¿‡ä¸­é—´è¡¨å®ç°
- æ•°æ®æƒé™åŸºäºå²—ä½å±‚çº§æ§åˆ¶

---

## 2. scopes.go æ”¹é€ 

```go
const (
    TenantModeAuto   = "auto"   // è‡ªåŠ¨æ·»åŠ  tenant_id è¿‡æ»¤ï¼ˆé»˜è®¤ï¼‰
    TenantModeManual = "manual" // æ‰‹åŠ¨æ§åˆ¶ WHERE æ¡ä»¶
)

// ManualTenantMode è®¾ç½®æ‰‹åŠ¨æ¨¡å¼ï¼ŒRepository å®Œå…¨æ§åˆ¶ WHERE
func ManualTenantMode(ctx context.Context) context.Context {
    return context.WithValue(ctx, tenantModeKey, TenantModeManual)
}
```

**æŸ¥è¯¢ä¼˜å…ˆçº§**ï¼š
1. `SkipTenantCheck` â†’ ä¸æ·»åŠ ä»»ä½•è¿‡æ»¤
2. `TenantModeManual` â†’ Repository æ‰‹åŠ¨æ§åˆ¶ WHERE
3. é»˜è®¤ (`TenantModeAuto`) â†’ è‡ªåŠ¨æ·»åŠ  `WHERE tenant_id = ?`

---

## 3. API è®¾è®¡

### è¶…ç®¡æ“ä½œ

```
POST   /api/v1/system/menus/assign             åˆ†é…èœå•ç»™ç§Ÿæˆ·
DELETE /api/v1/system/menus/unassign           æ’¤é”€åˆ†é…
```

### ç§Ÿæˆ·æ“ä½œ

```
GET    /api/v1/menus                           è·å–èœå•ï¼ˆç³»ç»Ÿ+è‡ªå®šä¹‰ï¼‰
POST   /api/v1/menus                           åˆ›å»ºè‡ªå®šä¹‰èœå•

GET    /api/v1/dict-types                      è·å–å­—å…¸ç±»å‹
POST   /api/v1/dict-types                      åˆ›å»ºè‡ªå®šä¹‰å­—å…¸

GET    /api/v1/orgs                            è·å–ç»„ç»‡ç»“æ„
POST   /api/v1/orgs                            åˆ›å»ºç»„ç»‡
```

### ç™»å½•

```
POST   /api/v1/:tenant_code/login              ç™»å½•ï¼ˆè·¯å¾„æºå¸¦ç§Ÿæˆ·codeï¼‰
```

---

## 4. å¸¸é‡å®šä¹‰

```go
package constants

const (
    // ç§Ÿæˆ·
    DefaultTenantID   = "000000000000000000" // é»˜è®¤ç§Ÿæˆ·IDï¼ˆ18ä¸ªé›¶ï¼‰
    DefaultTenantCode = "default"            // é»˜è®¤ç§Ÿæˆ·code
    SuperAdminRoleCode = "super_admin"       // è¶…ç®¡è§’è‰²code

    // ç”¨æˆ·ç±»å‹
    UserTypeUser        = 1 // æ™®é€šç”¨æˆ·
    UserTypeTenantAdmin = 2 // ç§Ÿæˆ·ç®¡ç†å‘˜
    UserTypeSuperAdmin  = 3 // è¶…çº§ç®¡ç†å‘˜
)
```

---

## 5. å®ç°æ¸…å•

### ç”¨æˆ·è§’è‰²ç³»ç»Ÿï¼ˆè§ [multi-tenant-login-design.md](./multi-tenant-login-design.md)ï¼‰
- [ ] `internal/model/tenant.go`
- [ ] `internal/model/user.go`
- [ ] `internal/model/role.go`
- [ ] `internal/repository/user_repo.go`
- [ ] `internal/repository/role_repo.go`
- [ ] `internal/service/auth_service.go`
- [ ] `internal/middleware/tenant.go`
- [ ] `internal/middleware/auth.go`

### èœå•ç³»ç»Ÿï¼ˆè§ [menu-system-design.md](./menu-system-design.md)ï¼‰
- [ ] `internal/repository/menu_repo.go`
- [ ] `internal/repository/tenant_menu_repo.go`
- [ ] `internal/repository/permission_repo.go`
- [ ] `internal/service/menu_service.go`
- [ ] `internal/service/role_service.go`

### å­—å…¸ç³»ç»Ÿï¼ˆè§ [dict-system-design.md](./dict-system-design.md)ï¼‰
- [ ] `internal/repository/dict_type_repo.go`
- [ ] `internal/repository/dict_item_repo.go`
- [ ] `internal/service/dict_service.go`

---

## 6. å¾…è¡¥å……åŠŸèƒ½

ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
| æ¨¡å— | è¯´æ˜ | å¤æ‚åº¦ |
|------|------|--------|
| é€šçŸ¥ä¸­å¿ƒ | ç«™å†…æ¶ˆæ¯ã€é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥ã€é€šçŸ¥æ¨¡æ¿ç®¡ç† | ä¸­ |
| æ–‡ä»¶ç®¡ç† | æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ç§Ÿæˆ·éš”ç¦»å­˜å‚¨ã€æ–‡ä»¶åˆ†äº« | ä½ |
| APIç®¡ç† | APIå¯†é’¥ç®¡ç†ã€APIé™æµ/é‰´æƒã€APIæ–‡æ¡£ | ä¸­ |

ğŸŸ¢ ä½ä¼˜å…ˆçº§
| æ¨¡å— | è¯´æ˜ | å¤æ‚åº¦ |
|------|------|--------|
| å®šæ—¶ä»»åŠ¡ | ä»»åŠ¡è°ƒåº¦ç®¡ç†ã€æ‰§è¡Œç›‘æ§ã€ä»»åŠ¡æ—¥å¿— | ä½ |
| ç›‘æ§å‘Šè­¦ | ç³»ç»Ÿæ€§èƒ½ç›‘æ§ã€å¼‚å¸¸å‘Šè­¦ã€èµ„æºä½¿ç”¨ç›‘æ§ | é«˜ |
| å¤‡ä»½æ¢å¤ | æ•°æ®å¤‡ä»½ã€æ•°æ®æ¢å¤ã€ç§Ÿæˆ·æ•°æ®è¿ç§» | é«˜ |
| ç§Ÿæˆ·ç®¡ç† | ç§Ÿæˆ·æ³¨å†Œ/å¼€é€šã€å¥—é¤/ç‰ˆæœ¬ç®¡ç† | ä½ |
