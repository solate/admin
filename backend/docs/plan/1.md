# å¤šç§Ÿæˆ·SaaSåç«¯ç®¡ç†ç³»ç»Ÿè®¾è®¡

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

**åˆ†é…æœºåˆ¶**ï¼šè¶…ç®¡åˆ›å»ºç³»ç»Ÿæ¨¡æ¿ â†’ å‹¾é€‰åˆ†é…ç»™ç§Ÿæˆ· â†’ ç§Ÿæˆ·çœ‹åˆ°è¢«åˆ†é…çš„æ•°æ®

**è§’è‰²å±‚çº§**ï¼š
- è¶…çº§ç®¡ç†å‘˜ (SuperAdmin)ï¼šç®¡ç†å¹³å°æ¨¡æ¿ï¼Œåˆ†é…ç»™ç§Ÿæˆ·
- ç§Ÿæˆ·ç®¡ç†å‘˜ (TenantAdmin)ï¼šç»§æ‰¿ç³»ç»Ÿæ¨¡æ¿ï¼Œæ·»åŠ è‡ªå®šä¹‰æ•°æ®
- æ™®é€šç”¨æˆ· (User)ï¼šä½¿ç”¨è¢«æˆæƒçš„åŠŸèƒ½

---

## 1. æ•°æ®åº“è®¾è®¡

### 1.1 èœå•è¡¨ (menus)

```sql
CREATE TABLE menus (
    menu_id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(20) NOT NULL,
    source_type VARCHAR(20) NOT NULL,       -- 'SYSTEM' | 'CUSTOM'
    template_id VARCHAR(36),
    can_override BOOLEAN DEFAULT FALSE,
    is_readonly BOOLEAN DEFAULT FALSE,
    is_enabled BOOLEAN DEFAULT TRUE,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL,              -- 'MENU' | 'BUTTON'
    parent_id VARCHAR(36),
    path VARCHAR(255),
    resource VARCHAR(255),
    permission_code VARCHAR(100),
    sort INT DEFAULT 0,
    INDEX idx_tenant_source (tenant_id, source_type)
);
```

### 1.2 ç§Ÿæˆ·èœå•åˆ†é…è¡¨ (tenant_menu)

```sql
CREATE TABLE tenant_menu (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(20) NOT NULL,
    template_id VARCHAR(36) NOT NULL,       -- ç³»ç»Ÿèœå•ID
    override_name VARCHAR(100),
    override_icon VARCHAR(100),
    is_enabled BOOLEAN DEFAULT TRUE,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_by VARCHAR(100),
    UNIQUE KEY uk_tenant_menu (tenant_id, template_id)
);
```

### 1.3 å­—å…¸è¡¨ (dict_types)

```sql
CREATE TABLE dict_types (
    type_id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(20) NOT NULL,
    source_type VARCHAR(20) NOT NULL,
    template_id VARCHAR(36),
    can_override BOOLEAN DEFAULT FALSE,
    is_readonly BOOLEAN DEFAULT FALSE,
    type_code VARCHAR(50) NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    INDEX idx_tenant_source (tenant_id, source_type)
);

CREATE TABLE dict_items (
    data_id VARCHAR(36) PRIMARY KEY,
    type_id VARCHAR(36) NOT NULL,
    tenant_id VARCHAR(20) NOT NULL,
    label VARCHAR(100) NOT NULL,
    value VARCHAR(100) NOT NULL,
    sort INT DEFAULT 0
);
```

**æ³¨æ„**ï¼šå­—å…¸ç³»ç»Ÿä¸éœ€è¦åˆ†é…è¡¨ï¼Œæ‰€æœ‰ç§Ÿæˆ·éƒ½å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå­—å…¸ï¼Œç§Ÿæˆ·å¯ä»¥é€‰æ‹©è¦†ç›–æ˜¾ç¤ºæ–‡æœ¬ã€‚è¯¦ç»†è®¾è®¡è§ [dict-system-design.md](./dict-system-design.md)ã€‚

### 1.4 ç»„ç»‡è¡¨ (organizations) - ç‹¬ç«‹è®¾è®¡

```sql
CREATE TABLE organizations (
    org_id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(20) NOT NULL,
    parent_id VARCHAR(36),
    org_name VARCHAR(100) NOT NULL,
    org_code VARCHAR(50),
    sort INT DEFAULT 0,
    status TINYINT DEFAULT 1,
    INDEX idx_tenant (tenant_id)
);
```

---

## 2. scopes.go æ”¹é€ 

### 2.1 æ–°å¢å¸¸é‡å’Œå‡½æ•°

```go
const (
    TenantModeAuto   = "auto"   // è‡ªåŠ¨æ·»åŠ  tenant_id è¿‡æ»¤ï¼ˆé»˜è®¤ï¼‰
    TenantModeManual = "manual" // æ‰‹åŠ¨æ§åˆ¶ WHERE æ¡ä»¶
)

// ManualTenantMode è®¾ç½®æ‰‹åŠ¨æ¨¡å¼ï¼ŒRepository å®Œå…¨æ§åˆ¶ WHERE
func ManualTenantMode(ctx context.Context) context.Context {
    return context.WithValue(ctx, tenantModeKey, TenantModeManual)
}
```

### 2.2 æŸ¥è¯¢å›è°ƒé€»è¾‘

```
ä¼˜å…ˆçº§ï¼š
1. SkipTenantCheck      â†’ ä¸æ·»åŠ ä»»ä½•è¿‡æ»¤
2. TenantModeManual     â†’ ä¸è‡ªåŠ¨æ·»åŠ ï¼ŒRepository æ‰‹åŠ¨æ§åˆ¶ WHERE
3. é»˜è®¤ (TenantModeAuto) â†’ è‡ªåŠ¨æ·»åŠ  WHERE tenant_id = ?
```

---

## 3. Repository å±‚å°è£…ç¤ºä¾‹

### 3.1 èœå•æŸ¥è¯¢

```go
// æŸ¥è¯¢è‡ªå®šä¹‰èœå•ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
func (r *MenuRepo) GetCustomMenus(ctx context.Context, tenantID string) ([]*model.Menu, error) {
    ctx = database.WithTenantID(ctx, tenantID)
    return r.q.Permission.WithContext(ctx).
        Where(r.q.Permission.SourceType.Eq("CUSTOM")).
        Find()
}

// æŸ¥è¯¢ç³»ç»Ÿèœå•ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
func (r *MenuRepo) GetSystemMenus(ctx context.Context, menuIDs []string) ([]*model.Menu, error) {
    ctx = database.ManualTenantMode(ctx)
    return r.q.Permission.WithContext(ctx).
        Where(r.q.Permission.TenantID.Eq(constants.DefaultTenantID)). // é»˜è®¤ç§Ÿæˆ·ï¼Œtenant_id ä¸ºç©º
        Where(r.q.Permission.SourceType.Eq("SYSTEM")).
        Where(r.q.Permission.MenuID.In(menuIDs...)).
        Find()
}

// è·å–åˆ†é…çš„èœå•ID
func (r *AssignmentRepo) GetAssignedMenuIDs(ctx context.Context, tenantID string) ([]string, error) {
    return r.q.TenantMenuAssignment.WithContext(ctx).
        Where(r.q.TenantMenuAssignment.TenantID.Eq(tenantID)).
        Where(r.q.TenantMenuAssignment.IsEnabled.Eq(true)).
        Select(r.q.TenantMenuAssignment.TemplateID).
        Strings()
}
```

### 3.2 ç»„ç»‡æŸ¥è¯¢

```go
// ç§Ÿæˆ·æŸ¥è¯¢ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
func (r *OrgRepo) ListByTenant(ctx context.Context, tenantID string) ([]*model.Organization, error) {
    ctx = database.WithTenantID(ctx, tenantID)
    return r.q.Organization.WithContext(ctx).Find()
}

// è¶…ç®¡æŸ¥è¯¢æ‰€æœ‰ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
func (r *OrgRepo) ListAll(ctx context.Context) ([]*model.Organization, error) {
    ctx = database.ManualTenantMode(ctx)
    return r.q.Organization.WithContext(ctx).Find()
}
```

---

## 4. Service å±‚ä¸šåŠ¡é€»è¾‘

### 4.1 è¶…ç®¡åˆ›å»ºç³»ç»Ÿèœå•

```go
func (s *MenuService) CreateSystemMenu(ctx context.Context, req *CreateMenuRequest) error {
    menu := &model.Menu{
        MenuID:      uuid.New().String(),
        TenantID:    constants.DefaultTenantID, // ä¸ºç©ºå­—ç¬¦ä¸²
        SourceType:  "SYSTEM",
        Name:        req.Name,
        Type:        req.Type,
        CanOverride: true,
    }
    return s.menuRepo.Create(ctx, menu)
}
```

### 4.2 è¶…ç®¡åˆ†é…èœå•ç»™ç§Ÿæˆ·

```go
func (s *MenuService) AssignMenusToTenant(ctx context.Context, tenantID string, menuIDs []string) error {
    for _, menuID := range menuIDs {
        assignment := &model.TenantMenuAssignment{
            ID:         uuid.New().String(),
            TenantID:   tenantID,
            TemplateID: menuID,
            IsEnabled:  true,
        }
        s.assignmentRepo.Create(ctx, assignment)
    }
    return nil
}
```

### 4.3 ç§Ÿæˆ·æŸ¥è¯¢èœå•

```go
func (s *MenuService) GetTenantMenus(ctx context.Context, tenantID string) ([]*model.Menu, error) {
    // 1. æŸ¥è¯¢è‡ªå®šä¹‰èœå•
    customMenus, _ := s.menuRepo.GetCustomMenus(ctx, tenantID)

    // 2. è·å–åˆ†é…çš„ç³»ç»Ÿèœå•ID
    assignedIDs, _ := s.assignmentRepo.GetAssignedMenuIDs(ctx, tenantID)

    // 3. æŸ¥è¯¢ç³»ç»Ÿèœå•
    systemMenus, _ := s.menuRepo.GetSystemMenus(ctx, assignedIDs)

    // 4. åˆå¹¶ç»“æœ
    result := append(customMenus, systemMenus...)
    for _, menu := range systemMenus {
        assignment := s.assignmentRepo.GetAssignment(ctx, tenantID, menu.MenuID)
        if assignment != nil {
            menu.Name = assignment.OverrideName
            menu.IsEnabled = assignment.IsEnabled
        }
    }
    return result, nil
}
```

---

## 5. API è®¾è®¡

### è¶…ç®¡æ“ä½œ

```
POST   /api/v1/system/menus                    åˆ›å»ºç³»ç»Ÿèœå•
PUT    /api/v1/system/menus/:id                æ›´æ–°ç³»ç»Ÿèœå•
POST   /api/v1/system/menus/assign             åˆ†é…èœå•ç»™ç§Ÿæˆ·
DELETE /api/v1/system/menus/unassign           æ’¤é”€åˆ†é…

POST   /api/v1/system/dict-types               åˆ›å»ºç³»ç»Ÿå­—å…¸
POST   /api/v1/system/dict-types/assign        åˆ†é…å­—å…¸ç»™ç§Ÿæˆ·
```

### ç§Ÿæˆ·æ“ä½œ

```
GET    /api/v1/menus                           è·å–èœå•ï¼ˆç³»ç»Ÿ+è‡ªå®šä¹‰ï¼‰
POST   /api/v1/menus                           åˆ›å»ºè‡ªå®šä¹‰èœå•
PUT    /api/v1/menus/:id/override              è¦†ç›–ç³»ç»Ÿèœå•å±æ€§

GET    /api/v1/dict-types                      è·å–å­—å…¸ç±»å‹
POST   /api/v1/dict-types                      åˆ›å»ºè‡ªå®šä¹‰å­—å…¸

GET    /api/v1/orgs                            è·å–ç»„ç»‡ç»“æ„
POST   /api/v1/orgs                            åˆ›å»ºç»„ç»‡
```

---

## 6. å¸¸é‡å®šä¹‰

```go
package constants

const (
    // ç§Ÿæˆ·
    DefaultTenantID   = "00000000000000000000" // é»˜è®¤ç§Ÿæˆ·IDï¼ˆ20ä¸ªé›¶)
    DefaultTenantCode = "default" // é»˜è®¤ç§Ÿæˆ·code

    // ç”¨æˆ·ç±»å‹
    UserTypeUser        = 1 // æ™®é€šç”¨æˆ·
    UserTypeTenantAdmin = 2 // ç§Ÿæˆ·ç®¡ç†å‘˜
    UserTypeSuperAdmin  = 3 // è¶…çº§ç®¡ç†å‘˜

    // æ¥æºç±»å‹
    SourceTypeSystem = "SYSTEM"
    SourceTypeCustom = "CUSTOM"

    // èœå•ç±»å‹
    TypeMenu   = "MENU"
    TypeButton = "BUTTON"
)
```

---

## 7. å®ç°æ¸…å•

### æ•°æ®åº“

- [x] `pkg/database/scopes.go` æ·»åŠ  `ManualTenantMode`
- [x] `pkg/constants/system.go` æ·»åŠ  `DefaultTenantID = "00000000000000000000"`
- [ ] èœå•è¡¨ï¼š`tenant_id`, `parent_id`, `name`, `path`, `sort`
- [ ] æ–°å»º `tenant_menus` è¡¨ï¼ˆç§Ÿæˆ·èœå•è¾¹ç•Œï¼‰
- [ ] è§’è‰²è¡¨ï¼š`tenant_id`, `name`, `code`, `type`, `parent_role_code`
- [ ] å­—å…¸ç±»å‹è¡¨ï¼š`tenant_id`, `type_code`, `type_name`
- [ ] å­—å…¸é¡¹è¡¨ï¼š`type_id`, `tenant_id`, `label`, `value`, `sort`
- [ ] ç»„ç»‡è¡¨ï¼š`tenant_id`, `parent_id`, `org_name`, `org_code`

### åç«¯ä»£ç 

#### èœå•ç³»ç»Ÿï¼ˆè§ [menu-system-design.md](./menu-system-design.md)ï¼‰
- [ ] `internal/repository/menu_repo.go` èœå•æŸ¥è¯¢
- [ ] `internal/repository/tenant_menu_repo.go` ç§Ÿæˆ·èœå•è¾¹ç•Œ
- [ ] `internal/service/menu_service.go` åˆ›å»ºã€åˆ†é…ã€è¦†ç›–é€»è¾‘
- [ ] `internal/router/` æ·»åŠ è¶…ç®¡åˆ†é…æ¥å£

#### å­—å…¸ç³»ç»Ÿï¼ˆè§ [dict-system-design.md](./dict-system-design.md)ï¼‰
- [ ] `internal/repository/dict_type_repo.go` å­—å…¸ç±»å‹
- [ ] `internal/repository/dict_item_repo.go` å­—å…¸é¡¹
- [ ] `internal/service/dict_service.go` åˆ›å»ºã€è¦†ç›–ã€æ¢å¤é€»è¾‘
- [ ] `internal/router/` æ·»åŠ è¶…ç®¡å­—å…¸æ¥å£

#### è§’è‰²æƒé™ç³»ç»Ÿï¼ˆè§ [menu-system-design.md](./menu-system-design.md)ï¼‰
- [ ] `internal/repository/role_repo.go` è§’è‰²ç®¡ç†
- [ ] `internal/service/role_service.go` ç»§æ‰¿ã€è‡ªå®šä¹‰è§’è‰²
- [ ] `internal/service/auth_service.go` æƒé™æ£€æŸ¥



ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå¸¸ç”¨åŠŸèƒ½ï¼‰
æ¨¡å—	ç¼ºå°‘çš„è®¾è®¡å†…å®¹	å¤æ‚åº¦
é€šçŸ¥ä¸­å¿ƒ	ç«™å†…æ¶ˆæ¯ã€é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥ã€é€šçŸ¥æ¨¡æ¿ç®¡ç†	ä¸­
æ–‡ä»¶ç®¡ç†	æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ç§Ÿæˆ·éš”ç¦»å­˜å‚¨ã€æ–‡ä»¶åˆ†äº«	ä½
APIç®¡ç†	APIå¯†é’¥ç®¡ç†ã€APIé™æµ/é‰´æƒã€APIæ–‡æ¡£ï¼ˆSwaggerï¼‰	ä¸­
ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯æ ¹æ®éœ€è¦è¡¥å……ï¼‰
æ¨¡å—	ç¼ºå°‘çš„è®¾è®¡å†…å®¹	å¤æ‚åº¦
å®šæ—¶ä»»åŠ¡	ä»»åŠ¡è°ƒåº¦ç®¡ç†ã€æ‰§è¡Œç›‘æ§ã€ä»»åŠ¡æ—¥å¿—	ä½
ç›‘æ§å‘Šè­¦	ç³»ç»Ÿæ€§èƒ½ç›‘æ§ã€å¼‚å¸¸å‘Šè­¦ã€èµ„æºä½¿ç”¨ç›‘æ§ã€ç§Ÿæˆ·ç”¨é‡ç»Ÿè®¡	é«˜
å¤‡ä»½æ¢å¤	æ•°æ®å¤‡ä»½ã€æ•°æ®æ¢å¤ã€ç§Ÿæˆ·æ•°æ®è¿ç§»	é«˜
ç§Ÿæˆ·ç®¡ç†	ç§Ÿæˆ·æ³¨å†Œ/å¼€é€šã€å¥—é¤/ç‰ˆæœ¬ç®¡ç†	ä½
ç³»ç»Ÿé…ç½®	ç³»ç»Ÿå‚æ•°é…ç½®ã€ç§Ÿæˆ·çº§é…ç½®ã€é…ç½®ç‰ˆæœ¬ç®¡ç†	ä½
å‰ç«¯ä¸ªæ€§åŒ–	ä¸»é¢˜é…ç½®ã€å¸ƒå±€é…ç½®ã€é¦–é¡µé…ç½®	ä½
