# 多租户SaaS后端管理系统设计

## 核心设计原则

**分配机制**：超管创建系统模板 → 勾选分配给租户 → 租户看到被分配的数据

**角色层级**：
- 超级管理员 (SuperAdmin)：管理平台模板，分配给租户
- 租户管理员 (TenantAdmin)：继承系统模板，添加自定义数据
- 普通用户 (User)：使用被授权的功能

---

## 1. 数据库设计

### 1.1 菜单表 (menus)

```sql
CREATE TABLE menus (
    menu_id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    source_type VARCHAR(20) NOT NULL,       -- 'SYSTEM' | 'CUSTOM'
    template_id VARCHAR(36),
    can_override BOOLEAN DEFAULT FALSE,
    is_readonly BOOLEAN DEFAULT FALSE,
    is_enabled BOOLEAN DEFAULT TRUE,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL,              -- 'MENU' | 'BUTTON'
    parent_id VARCHAR(36),
    path VARCHAR(255),
    resource VARCHAR(255),
    permission_code VARCHAR(100),
    sort INT DEFAULT 0,
    INDEX idx_tenant_source (tenant_id, source_type)
);
```

### 1.2 租户菜单分配表 (tenant_menu)

```sql
CREATE TABLE tenant_menu (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    template_id VARCHAR(36) NOT NULL,       -- 系统菜单ID
    override_name VARCHAR(100),
    override_icon VARCHAR(100),
    is_enabled BOOLEAN DEFAULT TRUE,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_by VARCHAR(100),
    UNIQUE KEY uk_tenant_menu (tenant_id, template_id)
);
```

### 1.3 字典表 (dict_types)

```sql
CREATE TABLE dict_types (
    type_id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    source_type VARCHAR(20) NOT NULL,
    template_id VARCHAR(36),
    can_override BOOLEAN DEFAULT FALSE,
    is_readonly BOOLEAN DEFAULT FALSE,
    type_code VARCHAR(50) NOT NULL,
    type_name VARCHAR(100) NOT NULL,
    INDEX idx_tenant_source (tenant_id, source_type)
);

CREATE TABLE dict_items (
    data_id VARCHAR(36) PRIMARY KEY,
    type_id VARCHAR(36) NOT NULL,
    tenant_id VARCHAR(36) NOT NULL,
    label VARCHAR(100) NOT NULL,
    value VARCHAR(100) NOT NULL,
    sort INT DEFAULT 0
);
```

### 1.4 租户字典分配表 (tenant_dict_assignments)

```sql
CREATE TABLE tenant_dict_assignments (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    template_id VARCHAR(36) NOT NULL,
    override_name VARCHAR(100),
    is_enabled BOOLEAN DEFAULT TRUE,
    UNIQUE KEY uk_tenant_dict (tenant_id, template_id)
);
```

### 1.5 组织表 (organizations) - 独立设计

```sql
CREATE TABLE organizations (
    org_id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    parent_id VARCHAR(36),
    org_name VARCHAR(100) NOT NULL,
    org_code VARCHAR(50),
    sort INT DEFAULT 0,
    status TINYINT DEFAULT 1,
    INDEX idx_tenant (tenant_id)
);
```

---

## 2. scopes.go 改造

### 2.1 新增常量和函数

```go
const (
    TenantModeAuto   = "auto"   // 自动添加 tenant_id 过滤（默认）
    TenantModeManual = "manual" // 手动控制 WHERE 条件
)

// ManualTenantMode 设置手动模式，Repository 完全控制 WHERE
func ManualTenantMode(ctx context.Context) context.Context {
    return context.WithValue(ctx, tenantModeKey, TenantModeManual)
}
```

### 2.2 查询回调逻辑

```
优先级：
1. SkipTenantCheck      → 不添加任何过滤
2. TenantModeManual     → 不自动添加，Repository 手动控制 WHERE
3. 默认 (TenantModeAuto) → 自动添加 WHERE tenant_id = ?
```

---

## 3. Repository 层封装示例

### 3.1 菜单查询

```go
// 查询自定义菜单（自动模式）
func (r *MenuRepo) GetCustomMenus(ctx context.Context, tenantID string) ([]*model.Menu, error) {
    ctx = database.WithTenantID(ctx, tenantID)
    return r.q.Permission.WithContext(ctx).
        Where(r.q.Permission.SourceType.Eq("CUSTOM")).
        Find()
}

// 查询系统菜单（手动模式）
func (r *MenuRepo) GetSystemMenus(ctx context.Context, menuIDs []string) ([]*model.Menu, error) {
    ctx = database.ManualTenantMode(ctx)
    return r.q.Permission.WithContext(ctx).
        Where(r.q.Permission.TenantID.Eq(constants.DefaultTenantID)). // 默认租户，tenant_id 为空
        Where(r.q.Permission.SourceType.Eq("SYSTEM")).
        Where(r.q.Permission.MenuID.In(menuIDs...)).
        Find()
}

// 获取分配的菜单ID
func (r *AssignmentRepo) GetAssignedMenuIDs(ctx context.Context, tenantID string) ([]string, error) {
    return r.q.TenantMenuAssignment.WithContext(ctx).
        Where(r.q.TenantMenuAssignment.TenantID.Eq(tenantID)).
        Where(r.q.TenantMenuAssignment.IsEnabled.Eq(true)).
        Select(r.q.TenantMenuAssignment.TemplateID).
        Strings()
}
```

### 3.2 组织查询

```go
// 租户查询（自动模式）
func (r *OrgRepo) ListByTenant(ctx context.Context, tenantID string) ([]*model.Organization, error) {
    ctx = database.WithTenantID(ctx, tenantID)
    return r.q.Organization.WithContext(ctx).Find()
}

// 超管查询所有（手动模式）
func (r *OrgRepo) ListAll(ctx context.Context) ([]*model.Organization, error) {
    ctx = database.ManualTenantMode(ctx)
    return r.q.Organization.WithContext(ctx).Find()
}
```

---

## 4. Service 层业务逻辑

### 4.1 超管创建系统菜单

```go
func (s *MenuService) CreateSystemMenu(ctx context.Context, req *CreateMenuRequest) error {
    menu := &model.Menu{
        MenuID:      uuid.New().String(),
        TenantID:    constants.DefaultTenantID, // 为空字符串
        SourceType:  "SYSTEM",
        Name:        req.Name,
        Type:        req.Type,
        CanOverride: true,
    }
    return s.menuRepo.Create(ctx, menu)
}
```

### 4.2 超管分配菜单给租户

```go
func (s *MenuService) AssignMenusToTenant(ctx context.Context, tenantID string, menuIDs []string) error {
    for _, menuID := range menuIDs {
        assignment := &model.TenantMenuAssignment{
            ID:         uuid.New().String(),
            TenantID:   tenantID,
            TemplateID: menuID,
            IsEnabled:  true,
        }
        s.assignmentRepo.Create(ctx, assignment)
    }
    return nil
}
```

### 4.3 租户查询菜单

```go
func (s *MenuService) GetTenantMenus(ctx context.Context, tenantID string) ([]*model.Menu, error) {
    // 1. 查询自定义菜单
    customMenus, _ := s.menuRepo.GetCustomMenus(ctx, tenantID)

    // 2. 获取分配的系统菜单ID
    assignedIDs, _ := s.assignmentRepo.GetAssignedMenuIDs(ctx, tenantID)

    // 3. 查询系统菜单
    systemMenus, _ := s.menuRepo.GetSystemMenus(ctx, assignedIDs)

    // 4. 合并结果
    result := append(customMenus, systemMenus...)
    for _, menu := range systemMenus {
        assignment := s.assignmentRepo.GetAssignment(ctx, tenantID, menu.MenuID)
        if assignment != nil {
            menu.Name = assignment.OverrideName
            menu.IsEnabled = assignment.IsEnabled
        }
    }
    return result, nil
}
```

---

## 5. API 设计

### 超管操作

```
POST   /api/v1/system/menus                    创建系统菜单
PUT    /api/v1/system/menus/:id                更新系统菜单
POST   /api/v1/system/menus/assign             分配菜单给租户
DELETE /api/v1/system/menus/unassign           撤销分配

POST   /api/v1/system/dict-types               创建系统字典
POST   /api/v1/system/dict-types/assign        分配字典给租户
```

### 租户操作

```
GET    /api/v1/menus                           获取菜单（系统+自定义）
POST   /api/v1/menus                           创建自定义菜单
PUT    /api/v1/menus/:id/override              覆盖系统菜单属性

GET    /api/v1/dict-types                      获取字典类型
POST   /api/v1/dict-types                      创建自定义字典

GET    /api/v1/orgs                            获取组织结构
POST   /api/v1/orgs                            创建组织
```

---

## 6. 常量定义

```go
package constants

const (
    // 租户
    DefaultTenantID   = ""       // 默认租户ID为空字符串
    DefaultTenantCode = "default" // 默认租户code

    // 用户类型
    UserTypeUser        = 1 // 普通用户
    UserTypeTenantAdmin = 2 // 租户管理员
    UserTypeSuperAdmin  = 3 // 超级管理员

    // 来源类型
    SourceTypeSystem = "SYSTEM"
    SourceTypeCustom = "CUSTOM"

    // 菜单类型
    TypeMenu   = "MENU"
    TypeButton = "BUTTON"
)
```

---

## 7. 实现清单

### 数据库

- [ ] 菜单表添加字段：`source_type`, `template_id`, `can_override`
- [ ] 新建 `tenant_menu_assignments` 表
- [ ] 字典表添加字段：`source_type`, `template_id`, `can_override`
- [ ] 新建 `tenant_dict_assignments` 表
- [ ] 组织表保持独立设计

### 后端代码

- [x] `pkg/database/scopes.go` 添加 `ManualTenantMode`
- [ ] `internal/repository/menu_repo.go` 实现分配查询
- [ ] `internal/repository/assignment_repo.go` 新建分配表仓库
- [ ] `internal/repository/dict_repo.go` 实现字典分配查询
- [ ] `internal/service/menu_service.go` 实现创建、分配、覆盖逻辑
- [ ] `internal/service/dict_service.go` 同菜单逻辑
- [ ] `internal/router/` 添加超管分配接口
